---
# TODO: Check for supported operating systems
#       Currently supported operating systems:
#
#       - Ubuntu 20.04 LTS
#

# SSH keys assign to the 'root' user on your systems
- name: Add ssh keys - root user
  ansible.posix.authorized_key:
    user: root
    key: "{{ lookup('file', '{{item}}') }}"
    state: present
  with_fileglob: "{{ system_ssh_keys_dir }}/*.pub"
  tags:
    - install
    - update

# SSH keys assign to the 'OS' user on your systems
- name: Add ssh keys - OS user
  ansible.posix.authorized_key:
    user: "{{ ansible_user }}"
    key: "{{ lookup('file', '{{item}}') }}"
    state: present
  with_fileglob: "{{ system_ssh_keys_dir }}/*.pub"
  tags:
    - install
    - update

# Update OS on each system
- name: Update OS
  ansible.builtin.package:
    name: '*'
    state: latest
    update_cache: yes
  tags:
    - install
    - update
    
# TODO: Add code here to support RHEL/CentOS for code
# - name: Disable the firewalld # CentOS ONLY
#   systemd:
#     name: firewalld
#     enabled: no
#     state: stopped
#   tags:
#     - install

# - name: Disable SELinux # CentOS ONLY
#   shell: |
#     /usr/sbin/setenforce 0
#     /usr/bin/sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config
#     exit 0
#   tags:
#     - install
 
# Add SAS Certificates to support SAS Viya
- name: Adding SAS certs
  ansible.builtin.shell: |
    curl -skf http://delphi.unx.sas.com/dumpster/smitty2/certs/sasroot.crt -o /etc/ssl/certs/sasroot.crt
    curl -skf http://delphi.unx.sas.com/dumpster/smitty2/certs/sasroot2.crt -o /etc/ssl/certs/sasroot2.crt
    curl -skf http://delphi.unx.sas.com/dumpster/smitty2/certs/sasinter.crt -o /etc/ssl/certs/sasinter.crt
    update-ca-certificates
  when: ansible_distribution == "Ubuntu" and ansible_distribution_version == "20.04"
  tags:
    - install
    - update
