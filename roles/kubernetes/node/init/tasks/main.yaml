# Copyright Â© 2022-2024, SAS Institute Inc., Cary, NC, USA. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0

---
- name: Generate compute node join token
  ansible.builtin.command: kubeadm token create --print-join-command
  register: kubeadm_join_cmd
  delegate_to: "{{ groups['k8s_control_plane'][0] }}"
  tags:
    - install

- name: Extract token and ca-cert-hash from join command
  ansible.builtin.set_fact:
    join_token: "{{ kubeadm_join_cmd.stdout.split()[4] }}"
    join_ca_hash: "{{ kubeadm_join_cmd.stdout.split()[6] }}"
  tags:
    - install

- name: Join compute nodes to the cluster using VIP FQDN
  ansible.builtin.command: "kubeadm join {{ kubernetes_vip_fqdn }}:6443 --token {{ join_token }} --discovery-token-ca-cert-hash {{ join_ca_hash }}"
  tags:
    - install
