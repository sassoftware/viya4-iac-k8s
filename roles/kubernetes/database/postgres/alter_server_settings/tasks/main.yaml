# Copyright Â© 2022-2023, SAS Institute Inc., Cary, NC, USA. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0

---
- name: Create PostgreSQL server settings file
  ansible.builtin.shell: |
    rm -f /tmp/postgres_system.psql && touch /tmp/postgres_system.psql
  tags:
    - install
    - update

- name: Alter PostgreSQL server max_connections - using default value
  ansible.builtin.shell: |
    echo 'ALTER SYSTEM SET max_connections = 1024;' >> /tmp/postgres_system.psql
    psql -f /tmp/postgres_system.psql
  when:
    - (postgres_system_setting_max_connections|length == 0)
  tags:
    - install
    - update

- name: Alter PostgreSQL server max_prepared_transactions - using default value
  ansible.builtin.shell: |
    echo 'ALTER SYSTEM SET max_prepared_transactions = 1024;' >> /tmp/postgres_system.psql
    psql -f /tmp/postgres_system.psql
  when:
    - (postgres_system_setting_max_prepared_transactions|length == 0)
  tags:
    - install
    - update

- name: Alter PostgreSQL server settings
  ansible.builtin.shell: |
    echo 'ALTER SYSTEM SET {{ item | replace("postgres_system_setting_","") }} = {{ vars[item] }};' >> /tmp/postgres_system.psql
  with_items: "{{ lookup('ansible.builtin.varnames', '^postgres_system_setting_.+', wantlist=True) }}"
  tags:
    - install
    - update
